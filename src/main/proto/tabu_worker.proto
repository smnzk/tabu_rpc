syntax = "proto3";

package worker.tabu;

option java_multiple_files = true;
option java_package = "org.example.tabu.proto";
option java_outer_classname = "TabuWorkerProto";

service TabuWorker {
  rpc StreamEvaluate(stream WorkerMessage)
      returns (stream WorkerResponse);
}

// ===== Stream messages coordinator -> worker =====
message WorkerMessage {
  oneof payload {
    Init init = 1;
    Iteration iter = 2;
    Resync resync = 3; // optional safety
  }
}

enum ObjectiveFunction {
  ROSENBROCK = 0;
  WOODS = 1;
}

message Init {
  int32 rank = 1;
  int32 n = 2;

  // Chunk assigned to this worker
  int32 chunk_start = 3;
  int32 chunk_end = 4;

  // Initial state and bounds sent ONCE
  repeated double solution0 = 5; // length n
  repeated double lower = 6;     // length n
  repeated double upper = 7;     // length n

  // Tabu parameters (sent once)
  int32 tabu_tenure = 8;

  // Objective selector
  ObjectiveFunction objective = 9;
}

message Iteration {
  int32 iteration = 1;
  double step = 2;

  // Coordinator tells workers the move that was chosen last iteration
  // so they can update their local s[] and tabu arrays identically.
  int32 chosen_index = 3;
  int32 chosen_direction = 4;   // -1 or +1
  double chosen_new_value = 5;

  // Current global best for aspiration checks (sent each iter)
  double f_best = 6;

  // How many moves to return (recommend 1..3 now, not 40)
  int32 max_candidates = 7;
}

// optional: once every X iterations send full solution to guarantee sync
message Resync {
  int32 iteration = 1;
  repeated double solution = 2; // length n
  double f_best = 3;
}

// ===== Worker -> coordinator =====
message WorkerResponse {
  oneof payload {
    IterationResponse iter_resp = 1;
    Ack ack = 2;
  }
}

message Ack {
  string msg = 1;
}

message CandidateMove {
  int32 index = 1;
  int32 direction = 2;
  double new_value = 3;
  double f_value = 4;
}

message IterationResponse {
  int32 iteration = 1;
  repeated CandidateMove candidates = 2; // now tiny
}
